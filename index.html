<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>社區QR報到與投票系統</title>
  <style>
    :root { --c1:#1f6feb; --c2:#0d1117; --c3:#161b22; --c4:#30363d; --c5:#f0f6fc; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: var(--c2); color: var(--c5); }
    header { background: var(--c3); border-bottom:1px solid var(--c4); padding: 12px 16px; }
    header h1 { margin:0; font-size: 18px; }
    nav { display:flex; gap:8px; padding: 10px 16px; background: var(--c3); position: sticky; top:0; z-index: 5; }
    nav button { background:#0b61d6; color:#fff; border:0; border-radius:8px; padding:8px 12px; cursor:pointer; }
    nav button.secondary { background: transparent; color: var(--c5); border:1px solid var(--c4); }
    nav button.active { background: var(--c1); }
    main { padding: 16px; }
    section { display:none; }
    section.active { display:block; }
    .card { background: var(--c3); border:1px solid var(--c4); border-radius:12px; padding:12px; margin-bottom:12px; }
    .row { display:flex; gap:12px; align-items:flex-end; flex-wrap: wrap; }
    .row > .col { flex: 1 1 240px; }
    label { display:block; font-size: 13px; margin-bottom:6px; }
    input[type="text"], select, textarea { width:100%; padding:8px; border-radius:8px; border:1px solid var(--c4); background: #0c131a; color: var(--c5); }
    .list { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:10px; }
    .list .item { background:#0c131a; border:1px solid var(--c4); border-radius:10px; padding:10px; }
    .muted { color:#9aa5b1; font-size: 12px; }
    .options { display:flex; gap:8px; flex-wrap: wrap; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:20px; border:1px solid var(--c4); }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:12px; }
    .qrbox { background:#0c131a; border:1px solid var(--c4); border-radius:12px; padding:8px; }
    .qrbox canvas, .qrbox img { width:100%; height:auto; }
    .actions { display:flex; gap:8px; }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { border:1px solid var(--c4); padding:6px 8px; text-align:left; }
    .success { color:#2ea043; }
    .error { color:#f85149; }
    .warn { color:#d29922; }
    .flex { display:flex; gap:8px; align-items:center; }
    .right { margin-left:auto; }
    .small { font-size:12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8"></script>
  
  <script>
    const LS_KEYS = { households: 'nwq_households', items: 'nwq_items', votes: 'nwq_votes' };
    const uid = () => (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now().toString(36) + Math.random().toString(36).slice(2));
    const load = (k, def) => { try { const v = JSON.parse(localStorage.getItem(k)); return v ?? def; } catch { return def; } };
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    let households = load(LS_KEYS.households, []);
    let items = load(LS_KEYS.items, []);
    let votes = load(LS_KEYS.votes, {});
    function persistAll() { save(LS_KEYS.households, households); save(LS_KEYS.items, items); save(LS_KEYS.votes, votes); }
    function activateTab(id) { document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active', b.dataset.tab === id)); document.querySelectorAll('section').forEach(s => s.classList.toggle('active', s.id === id)); }
    function escapeHtml(s) { return s.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }
    function sanitizeFilename(s) { return s.replace(/[^\w\u4e00-\u9fa5-]+/g, '_'); }

    function renderHouseholds() { const wrap = document.getElementById('householdList'); wrap.innerHTML=''; households.forEach(h => { const div=document.createElement('div'); div.className='item'; div.innerHTML = <div class='flex'><div><strong></strong><div class='muted small'>ID: </div></div><div class='right actions'><button class='secondary small' data-id=''>刪除</button></div></div>; div.querySelector('button').addEventListener('click', () => { households = households.filter(x => x.id !== h.id); persistAll(); renderHouseholds(); renderQRControls(); renderTally(); }); wrap.appendChild(div); }); }
    function addHousehold(name) { if (!name.trim()) return; households.push({ id: uid(), name: name.trim() }); persistAll(); renderHouseholds(); renderQRControls(); renderTally(); }

    function renderItems() { const wrap = document.getElementById('itemList'); wrap.innerHTML=''; items.forEach(it => { const div=document.createElement('div'); div.className='item'; const opts=it.options.map(o=><span class='pill'></span>).join(' '); div.innerHTML = <div class='flex'><div><strong></strong><div class='muted small'>類型：｜｜</div><div class='options small'></div></div><div class='right actions'><button class='secondary small' data-act='toggle' data-id=''></button><button class='secondary small' data-act='delete' data-id=''>刪除</button></div></div>; div.querySelector('[data-act="toggle"]').addEventListener('click', () => { it.isOpen = !it.isOpen; persistAll(); renderItems(); renderTally(); }); div.querySelector('[data-act="delete"]').addEventListener('click', () => { items = items.filter(x => x.id !== it.id); delete votes[it.id]; persistAll(); renderItems(); renderQRControls(); renderTally(); }); wrap.appendChild(div); }); }
    function addItem({ title, type, options }) { const optObjs = options.map(l => ({ id: uid(), label: l.trim() })).filter(o => o.label); const newItem = { id: uid(), title: title.trim(), type, options: optObjs.length ? optObjs : [ {id: uid(), label: '同意'}, {id: uid(), label: '不同意'} ], singleSelect: true, isOpen: true }; items.push(newItem); persistAll(); renderItems(); renderQRControls(); renderTally(); }

    function renderQRControls() { const selectItem = document.getElementById('qrItem'); selectItem.innerHTML = items.map(it => <option value=''>（）</option>).join(''); updateQROptionSelect(); }
    function updateQROptionSelect() { const itemId = document.getElementById('qrItem').value; const it = items.find(i => i.id === itemId); const sel = document.getElementById('qrOption'); sel.innerHTML = it ? it.options.map(o => <option value=''></option>).join('') : ''; }
    function generateQRGrid() { const itemId = document.getElementById('qrItem').value; const optionId = document.getElementById('qrOption').value; const grid = document.getElementById('qrGrid'); grid.innerHTML=''; const it = items.find(i => i.id === itemId); const opt = it?.options.find(o => o.id === optionId); if (!it || !opt) { grid.innerHTML = '<div class="warn">請選擇投票項目與選項</div>'; return; } households.forEach(h => { const payload = { t:'v', itemId, optionId, householdId: h.id }; const text = JSON.stringify(payload); const box = document.createElement('div'); box.className='qrbox'; const head = document.createElement('div'); head.className='small muted'; head.textContent = ${it.title}｜｜住戶：; const canvas = document.createElement('canvas'); const dl = document.createElement('button'); dl.className='secondary small'; dl.textContent='下載PNG'; box.appendChild(head); box.appendChild(canvas); box.appendChild(dl); grid.appendChild(box); QRCode.toCanvas(canvas, text, { width: 220 }, (err) => { if (err) { box.appendChild(document.createTextNode('生成失敗')); } }); dl.addEventListener('click', () => { const url = canvas.toDataURL('image/png'); const a = document.createElement('a'); a.href = url; a.download = ${sanitizeFilename(it.title)}__.png; a.click(); }); }); }

    let html5Qr = null; let scanning = false; let scanLog = [];
    function startScan() { if (scanning) return; const boxId='qrReader'; html5Qr = new Html5Qrcode(boxId); const config = { fps: 10, qrbox: 260 }; html5Qr.start({ facingMode: 'environment' }, config, onScanSuccess, onScanError).then(() => { scanning = true; setScanStatus('相機啟動'); }).catch(err => { setScanStatus('相機啟動失敗：' + err, 'error'); }); }
    function stopScan() { if (!html5Qr || !scanning) return; html5Qr.stop().then(() => { html5Qr.clear(); scanning=false; setScanStatus('相機已停止'); }); }
    function setScanStatus(msg, type='muted') { const el = document.getElementById('scanStatus'); el.className = type; el.textContent = msg; }
    function pushScanLog(entry) { scanLog.unshift({ time: new Date().toLocaleString(), ...entry }); scanLog = scanLog.slice(0, 10); const ul = document.getElementById('scanLog'); ul.innerHTML=''; scanLog.forEach(e => { const li = document.createElement('li'); li.className='small'; li.textContent = [] ; ul.appendChild(li); }); }
    function onScanSuccess(text) { try { const payload = JSON.parse(text); if (!payload || payload.t !== 'v') throw new Error('非投票QR碼'); const { itemId, optionId, householdId } = payload; const it = items.find(i => i.id === itemId); if (!it) { setScanStatus('投票項目不存在', 'error'); pushScanLog({ message:'項目不存在' }); return; } if (!it.isOpen) { setScanStatus('此投票項目已關閉', 'warn'); pushScanLog({ message: ${it.title} 已關閉 }); return; } const opt = it.options.find(o => o.id === optionId); if (!opt) { setScanStatus('投票選項不存在', 'error'); pushScanLog({ message:'選項不存在' }); return; } const h = households.find(x => x.id === householdId); if (!h) { setScanStatus('住戶不存在', 'error'); pushScanLog({ message:'住戶不存在' }); return; } votes[itemId] = votes[itemId] || {}; const prev = votes[itemId][householdId]; if (it.singleSelect && prev && prev !== optionId) { setScanStatus(重複投票： 已投 , 'warn'); pushScanLog({ message:重複投票｜｜ }); return; } if (prev === optionId) { setScanStatus(${h.name} 已投 （無變更）, 'muted'); pushScanLog({ message:已投過｜｜｜ }); return; } votes[itemId][householdId] = optionId; persistAll(); renderTally(); setScanStatus(投票成功：｜｜, 'success'); pushScanLog({ message:成功｜｜｜ }); } catch (e) { setScanStatus('解析失敗：' + (e?.message || e), 'error'); pushScanLog({ message:'解析失敗' }); } }
    function onScanError(err) {}
    function optLabelById(itemId, optionId) { const it = items.find(i => i.id === itemId); const o = it?.options.find(x => x.id === optionId); return o?.label || '未知選項'; }

    function renderTally() { const sel = document.getElementById('tallyItem'); sel.innerHTML = items.map(it => <option value=''>（）</option>).join(''); updateTally(); }
    function updateTally() { const itemId = document.getElementById('tallyItem').value; const it = items.find(i => i.id === itemId); const box = document.getElementById('tallyBox'); box.innerHTML=''; if (!it) { box.innerHTML = '<div class="warn">尚無投票項目</div>'; return; } const map = votes[itemId] || {}; const counts = Object.fromEntries(it.options.map(o => [o.id, 0])); Object.values(map).forEach(optId => { if (counts[optId] !== undefined) counts[optId]++; }); const table = document.createElement('table'); table.className='table'; const thead = document.createElement('thead'); thead.innerHTML = '<tr><th>選項</th><th>票數</th></tr>'; const tbody = document.createElement('tbody'); it.options.forEach(o => { const tr = document.createElement('tr'); tr.innerHTML = <td></td><td></td>; tbody.appendChild(tr); }); table.appendChild(thead); table.appendChild(tbody); box.appendChild(table); const detail = document.createElement('div'); detail.className='card'; const votedList = Object.entries(map); detail.innerHTML = <div class='muted small'>已投票：／住戶共 </div>; const ul = document.createElement('ul'); votedList.forEach(([hid, oid]) => { const h = households.find(x => x.id === hid); const li = document.createElement('li'); li.className='small'; li.textContent = ${h?.name || '未知住戶'}  ; ul.appendChild(li); }); detail.appendChild(ul); box.appendChild(detail); }

    function exportJSON() { const data = { households, items, votes }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'nwq-vote-data.json'; a.click(); URL.revokeObjectURL(url); }
    function importJSON(file) { if (!file) return; const reader = new FileReader(); reader.onload = () => { try { const data = JSON.parse(reader.result); if (!data || !Array.isArray(data.households) || !Array.isArray(data.items) || typeof data.votes !== 'object') throw new Error('格式不符'); households = data.households; items = data.items; votes = data.votes; persistAll(); renderHouseholds(); renderItems(); renderQRControls(); renderTally(); alert('匯入成功'); } catch(e) { alert('匯入失敗：' + e.message); } }; reader.readAsText(file); }

    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('nav button').forEach(b => b.addEventListener('click', () => activateTab(b.dataset.tab)));
      activateTab('tab-households');
      document.getElementById('addHouseholdBtn').addEventListener('click', () => { const name = document.getElementById('householdName').value; addHousehold(name); document.getElementById('householdName').value=''; });
      renderHouseholds();
      const optInput = document.getElementById('newItemOptions');
      document.getElementById('addDefaultOptions').addEventListener('click', () => { optInput.value = '同意\n不同意'; });
      document.getElementById('addItemBtn').addEventListener('click', () => { const title = document.getElementById('itemTitle').value.trim(); const type = document.getElementById('itemType').value; const options = optInput.value.split('\n').map(s => s.trim()).filter(Boolean); if (!title) { alert('請輸入項目名稱'); return; } addItem({ title, type, options }); document.getElementById('itemTitle').value=''; optInput.value=''; });
      renderItems();
      document.getElementById('qrItem').addEventListener('change', updateQROptionSelect);
      document.getElementById('qrGenBtn').addEventListener('click', generateQRGrid);
      renderQRControls();
      document.getElementById('scanStart').addEventListener('click', startScan);
      document.getElementById('scanStop').addEventListener('click', stopScan);
      document.getElementById('tallyItem').addEventListener('change', updateTally);
      document.getElementById('exportBtn').addEventListener('click', exportJSON);
      document.getElementById('importFile').addEventListener('change', (e) => importJSON(e.target.files[0]));
      renderTally();
    });
  </script>
</head>
<body>
  <header><h1>社區QR報到與投票系統</h1></header>
  <nav>
    <button class="active" data-tab="tab-households">住戶管理</button>
    <button class="secondary" data-tab="tab-items">投票項目</button>
    <button class="secondary" data-tab="tab-qr">生成QR</button>
    <button class="secondary" data-tab="tab-scan">掃描投票</button>
    <button class="secondary" data-tab="tab-tally">統計/匯出</button>
  </nav>
  <main>
    <section id="tab-households" class="active">
      <div class="card">
        <div class="row">
          <div class="col">
            <label>住戶名稱（例如：A棟-1203、王小明）</label>
            <input id="householdName" type="text" placeholder="輸入住戶名稱" />
          </div>
          <div class="col" style="max-width:200px">
            <button id="addHouseholdBtn">加入住戶</button>
          </div>
        </div>
      </div>
      <div class="list" id="householdList"></div>
    </section>

    <section id="tab-items">
      <div class="card">
        <div class="row">
          <div class="col">
            <label>項目名稱</label>
            <input id="itemTitle" type="text" placeholder="例如：社區泳池維修預算" />
          </div>
          <div class="col">
            <label>類型</label>
            <select id="itemType">
              <option value="議題">議題</option>
              <option value="臨時動議">臨時動議</option>
              <option value="選舉">選舉</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>選項（每行一個）</label>
            <textarea id="newItemOptions" rows="4" placeholder="預設為同意/不同意，可自行新增"></textarea>
            <div class="flex">
              <button class="secondary small" id="addDefaultOptions">插入 同意/不同意</button>
              <div class="right">
                <button id="addItemBtn">新增投票項目</button>
              </div>
            </div>
            <div class="muted small">同一項目預設只能選擇一個選擇（單選）。</div>
          </div>
        </div>
      </div>
      <div class="list" id="itemList"></div>
    </section>

    <section id="tab-qr">
      <div class="card">
        <div class="row">
          <div class="col">
            <label>選擇投票項目</label>
            <select id="qrItem"></select>
          </div>
          <div class="col">
            <label>選擇選項</label>
            <select id="qrOption"></select>
          </div>
          <div class="col" style="max-width:200px">
            <button id="qrGenBtn">為所有住戶生成QR</button>
          </div>
        </div>
      </div>
      <div class="grid" id="qrGrid"></div>
    </section>

    <section id="tab-scan">
      <div class="card">
        <div class="flex">
          <div class="actions">
            <button id="scanStart">啟動相機</button>
            <button class="secondary" id="scanStop">停止相機</button>
          </div>
          <div class="right muted" id="scanStatus">尚未啟動</div>
        </div>
      </div>
      <div id="qrReader" style="width:100%; max-width:520px"></div>
      <div class="card">
        <div class="muted small">掃描紀錄（近10筆）</div>
        <ul id="scanLog"></ul>
      </div>
    </section>

    <section id="tab-tally">
      <div class="card">
        <div class="row">
          <div class="col">
            <label>選擇投票項目</label>
            <select id="tallyItem"></select>
          </div>
          <div class="col actions" style="align-items:center">
            <button id="exportBtn">匯出JSON</button>
            <label class="secondary" style="padding:6px 10px; border-radius:8px; cursor:pointer">
              匯入JSON
              <input id="importFile" type="file" accept="application/json" style="display:none" />
            </label>
          </div>
        </div>
      </div>
      <div id="tallyBox"></div>
    </section>
  </main>
</body>
</html>
